 <!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DixitHelper induló oldal</title>
    <script type="text/javascript" >
    
        String.prototype.reverse = function() {
            return this.split("").reverse().join("");
        }

        function getEl(elId) {
            return document.getElementById(elId);
        }

        function setCookie(cname, cvalue, exdays) {
              var d = new Date();
              d.setTime(d.getTime() + (exdays*24*60*60*1000));
              var expires = "expires="+ d.toUTCString();
              document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }

        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for(var i = 0; i <ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }
        var textColor="#D0D0E4";
        var darkerTextColor="#A0A0B4";
        var evenDarkerTextColor="#808094";
        var colorDivContent = "";
        var selectedColor = "";
        var deviceHash;
        var running = false;
        var lastVersion = -1;
        var errorHappened = false;
        var myAddress=window.location.href.reverse().substring(10).reverse();
        var playerData = new Object();

        function alertIt(text,state) {
            alert(text);
            errorHappened = true;
        }

        function sendRest(service, callBack, errorCallBack = alertIt, post=false, postData=null) {
            var xhttp = new XMLHttpRequest();
            errorHappened = false;
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        callBack(xhttp.responseText)
                    } else {
                        errorCallBack(xhttp.responseText, this.status);
                    }
                }
            };
            if (post) {
                xhttp.open("POST", myAddress+service, true);
                xhttp.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
                xhttp.send(JSON.stringify(postData));
            } else {
                xhttp.open("GET", myAddress+service, true);
                xhttp.send();
            }
        }
        
        function addColorDiv(colStr,colName) {
            colorDivContent += "<div "+
                "style=\"display:inline-block; background-color: "+colStr+";"+
                  " width:150px; height:80px; margin: 20px; border: 2px solid #C0C0F0;\" "+
                  "colorName=\""+colName+"\" "+
                  "onClick=\"selectColor(\'"+colName+"\', this);\" "+
                  "id=\""+colName+"\" "+
                  ">"+
                "&nbsp;"+
                "</div>";
        }
        
        function selectColor(colName, divEl) {
            if (selectedColor!="") {
                document.getElementById(selectedColor).style.borderWidth="2px";
                document.getElementById(selectedColor).style.borderColor=textColor;
            }
            selectedColor=colName;
            divEl.style.borderWidth="10px";
            divEl.style.borderBottomColor=evenDarkerTextColor;
            divEl.style.borderRightColor=darkerTextColor;
        }

        function initColors(gameJson) {
            game = JSON.parse(gameJson);
            colorDivContent = "";
            Object.keys(game.availableColors).forEach(function(key, index) {addColorDiv(game.availableColors[key], key)});
            document.getElementById("colorsDiv").innerHTML = colorDivContent;
        }

        function checkVersion(version) {
            if (version!=lastVersion) {
                sendRest("getgame", initColors);
                lastVersion = version;
            }
        }

        function pollState() {
            if (!running) {
                running = true;
                sendRest("getgameversion", checkVersion)
                running = false;
            }
            setTimeout(function() {pollState();}, 500);
        }

        function storeDeviceHash(returnedDevHash) {
        }

        function checkDeviceAndRegisterIfNeeded(gameJson) {
            deviceHash = getCookie("dixitDevice");
            if (deviceHash=="") {
                deviceHash = 10000 + Math.round(Math.random(2)*89000);
                setCookie("dixitDevice", ""+deviceHash, 31);
            }
            game = JSON.parse(gameJson);
            var foundDevice = false;
            Object.keys(game.devices).forEach(function(deviceKey) {
                if (deviceKey==deviceHash) {
                    foundDevice=true;
                }
            });
            if (!foundDevice) {
                sendRest("connect/"+deviceHash,storeDeviceHash);
            }
        }

        function init() {
            getEl("playerName").value="";
            sendRest("getgame",checkDeviceAndRegisterIfNeeded);
            pollState();
        }

        function getPlayerHash() {
            var pHash;
            Object.keys(game.players).forEach(function(pName) {
                if (pName==playerData.playerName) {
                    pHash=game.players[pName].playerHash;
                }
            });
            return pHash;
        }

        function goToGame(gameJson) {
            game = JSON.parse(gameJson);
            var myHash = getPlayerHash();
            window.location.href = myAddress+"game.html?h="+myHash;
        }

        function playerAdded() {
            sendRest("getgame", goToGame);
            selectedColor="";
        }

        function registerPlayer() {
            var playerEl = document.getElementById("playerName");
            if (playerEl.value=="")
                return;
            if (selectedColor=="")
                return;
            running = true;
            playerData.deviceHash = deviceHash;
            playerData.playerName = playerEl.value;
            playerData.colorName = selectedColor;
            sendRest("addPlayer",playerAdded, alertIt, true,playerData);
            running = false;
        }
    </script>
</head>

<body onLoad="init();" style="text-align:center; background-color:#101040; color:#D0D0E4; font-size:30px; width:100%;">
<h2 style="text-align:center;">DIXITHELPER</h2>

<form ">
    Játékos neve: <input id="playerName" type="text" style="font-size:40px;" size="10" /><br><br>
    
</form>
Válassz színt ezek közül:<br>
<div id="colorsDiv" style="display:block;">
</div>
<br>
<div style="display:block;position:relative;text-align:center;width:100%;">
    <div style="display:block;text-align:center;background-color:gray;
                border: 10px solid #D0D0E4;border-right-color:#A0A0B4;
                border-bottom-color:#808094;width:200px;margin:auto;"
                onClick="registerPlayer();">
        START
    </div>
</div>

</body>

</html>
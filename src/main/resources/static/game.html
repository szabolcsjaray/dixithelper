 <!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DixitHelper játék oldal</title>
    <script type="text/javascript" >

        var rabbitSVG = "<svg xmlns:dc=\"http://purl.org/dc/elements/1.1/\" " +
         "xmlns:cc=\"http://creativecommons.org/ns#\" " +
         "xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\" " +
         "xmlns:svg=\"http://www.w3.org/2000/svg\" " +
         "xmlns=\"http://www.w3.org/2000/svg\" " +
         "xmlns:xlink=\"http://www.w3.org/1999/xlink\" " +
         "version=\"1.2\" " +
         "width=\"SIZE\" " +
         "height=\"SIZE\" " +
         "viewBox=\"0 0 600 600\" " +
         "style=\"position:absolute;top:TOP;left:LEFT;display:DISPLAY;\">" +
         "<path id=\"rabbit\" d=\"m 335.94313,30.576451 c -9.79312,-0.146115 -17.39091,4.439466 -17.39091,13.789758 " +
                     "0,11.508038 -2.91019,60.415461 1.40532,76.238951 4.31553,15.82355 21.58583,38.97215 34.51834," +
                     "54.67597 10.06946,12.22726 4.34772,41.69626 4.34772,56.0813 0,14.38499 -2.89751,25.9107 " +
                     "-8.65153,25.9107 -5.75402,0 -14.35971,5.75217 -20.11373,11.50612 -5.75395,5.75402 -11.51588," +
                     "12.95631 -18.70841,7.20229 -7.19251,-5.75402 -20.15388,-11.49441 -43.16987,-15.80992 -23.01609," +
                     "-4.31551 -61.84129,-0.0234 -86.29583,8.60763 -24.45458,8.63104 -76.25857,56.11061 -90.643535,77.6882" +
                     " -14.385056,21.5775 -15.799189,87.73247 -14.36068,97.80193 1.438509,10.06953 -2.908267,17.28255" +
                     " -10.100778,8.65153 -7.192459,-8.63104 -12.911438,-4.30381 -12.911438,-4.30381 0,0 -7.202292,14.37045" +
                     " -7.202292,21.56298 0,7.19244 2.854564,14.36068 2.854564,14.36068 0,0 -11.506099,8.65056 -11.506099,"+
                     "14.40458 0,5.75397 11.515881,15.83044 18.708391,24.46146 7.192546,8.63097 31.651182,25.89997 41.720624,"+
                     "24.46148 10.069543,-1.43851 28.775063,-0.0121 35.967573,4.3038 7.19253,4.31551 24.44687,10.06761 46.02443,"+
                     "11.5061 21.57752,1.43851 81.97845,5.75307 97.80193,5.75307 15.82357,0 20.1675,-2.86435 27.35996,"+
                     "-10.05688 7.19253,-7.19245 -5.78527,-15.84115 -10.10079,-25.9107 -4.31551,-10.06946 14.40363,"+
                     "-7.16912 20.15765,-8.60763 5.75402,-1.43849 21.59424,-11.5061 31.66376,-11.5061 10.06953,0 8.6165,"+
                     "10.05589 21.56298,15.80993 12.94654,5.75393 31.63939,24.43902 46.02443,27.31602 14.38497,2.87695 47.47173,"+
                     "0.0121 58.97979,-4.30381 11.50797,-4.31551 10.06946,-14.37044 0,-21.56297 -10.06955,-7.19244 -34.50663,"+
                     "-20.16742 -38.82214,-27.35994 -4.31551,-7.19246 -5.74329,-15.81969 1.44924,-23.01224 7.19251,-7.19252 14.35876,"+
                     "-4.30292 25.86678,-10.05685 11.50806,-5.75402 15.80992,-23.04354 15.80992,-33.11301 0,-10.06953 1.36928,"+
                     "-21.01352 5.75307,-27.31602 3.67345,-5.28128 5.10015,-22.13212 5.30499,-33.64009 0.21874,-12.28864 -5.29329,"+
                     "-15.24871 -9.60881,-22.44122 -4.31543,-7.19246 4.30285,-17.25917 10.05687,-17.25917 5.75402,0 31.65108,"+
                     "-4.33602 41.72062,-8.65153 10.06946,-4.31546 20.16744,-23.03273 27.35995,-31.66377 7.19246,-8.63095 1.41799,"+
                     "-27.31512 -8.65154,-33.06907 -10.06954,-5.75402 -10.07746,-21.59431 -18.70841,-31.66377 -8.63103,-10.06953"+
                     " -18.68507,-31.62961 -27.31604,-38.82213 -8.63101,-7.19253 -28.77502,-12.95535 -35.96755,-12.95535 -7.19253,"+
                     "0 -11.50612,9e-4 -11.50612,-5.75306 0,-5.75402 -1.44924,-12.9203 -1.44924,-25.86678 0,-12.94655 -16.24344,"+
                     "-68.464566 -37.3729,-102.149659 -4.40799,-7.027282 -11.5581,-5.405316 -20.15765,-2.898485 -5.69412,1.659863"+
                     " -8.60761,4.35564 -8.60761,23.056136 0,18.700566 -11.50515,-0.03133 -17.25917,-10.100794 -5.75403,-10.069512"+
                     " -15.86265,-21.58444 -28.80918,-24.461458 -2.42749,-0.539415 -4.76669,-0.800692 -7.02665,-0.834399 z\""+
                     " style=\"fill:COLOR;fill-opacity:1;stroke:STROKE;stroke-width:STROKE-WIDTH;\" />" +
         "</svg>";
         var circleSVG = "<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 20 20\" "+
                     " style=\"POS;width:SIZE;height:SIZE;position:absolute;display:block;\">" +
                     "<circle cx=\"10\" cy=\"10\" r=\"7\" stroke=\"white\" stroke-width=\"5\" fill=\"none\" />" +
                     "<circle cx=\"10\" cy=\"10\" r=\"7\" stroke=\"COLOR\" stroke-width=\"4\" fill=\"none\" />" +
                     "</svg>";
        const TOP_RIGHT_POS ="TOP-RIGHT"

        String.prototype.reverse = function() {
            return this.split("").reverse().join("");
        }

        function setCookie(cname, cvalue, exdays) {
              var d = new Date();
              d.setTime(d.getTime() + (exdays*24*60*60*1000));
              var expires = "expires="+ d.toUTCString();
              document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }

        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for(var i = 0; i <ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        function getRabbit(size, color, top, left, stroke="none", strokeWidth ="0px", display = "inline-block") {
            return rabbitSVG.replace(/SIZE/g,size).
                replace("COLOR",color).
                replace("TOP",top).
                replace("LEFT",left).
                replace("STROKE-WIDTH",strokeWidth).
                replace("STROKE",stroke).
                replace("DISPLAY",display);
        }

        function getCircle(color,size,pos) {
            var circle = circleSVG.replace("COLOR",color).replace(/SIZE/g,size);
            if (pos==TOP_RIGHT_POS) {
                circle = circle.replace("POS","top:10px;right:10px");
            } else {
                circle = circle.replace("POS", pos);
            }
            return circle;
        }

        var textColor="#D0D0E4";
        var darkerTextColor="#A0A0B4";
        var evenDarkerTextColor="#808094";
        var deviceHash;
        var myCard = -1;
        var myChoice = -1;
        var running = false;
        var lastVersion = -1;
        var errorHappened = false;
        var myAddress=window.location.href.slice(0,window.location.href.indexOf('?')-9);
        myAddress.reverse().substring(10).reverse();
        var playerData = new Object();
        var playerHash;
        var me = null;
        var pOrder = new Array();
        var hideCardSigns = false;
        var myLastState = "JUST_ARRIVED";
        var whileSettingCards = false;


        function alertIt(text,state) {
            alert(text);
            errorHappened = true;
        }

        function sendRest(service, callBack, errorCallBack = alertIt, post=false, postData=null) {
            var xhttp = new XMLHttpRequest();
            errorHappened = false;
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        callBack(xhttp.responseText)
                    } else {
                        errorCallBack(xhttp.responseText, this.status);
                    }
                }
            };
            if (post) {
                xhttp.open("POST", myAddress+service, true);
                xhttp.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
                xhttp.send(JSON.stringify(postData));
            } else {
                xhttp.open("GET", myAddress+service, true);
                xhttp.send();
            }
        }

        function getEl(elId) {
            return document.getElementById(elId);
        }

        function hideEl(elId) {
            getEl(elId).style.display = "none";
        }

        function showEl(elId, displayMode="block") {
            getEl(elId).style.display = displayMode;
        }

        function countReady() {
            var count = 0;
            Object.keys(game.players).forEach(function(pName) {
               if (game.players[pName].state=="WAITING_FOR_OTHERS_CHOICE") {
                   count++;
               }
            });
            return count;
        }

        function updateStateAndButtons() {
            if (me==null) {
                return;
            }
            hideEl("startButton");
            hideEl("newPlayerButton");
            hideEl("goOnButton");
            var stateDiv = getEl("state");
            if (me.state=="WAITING_FOR_GAME_START") {
                stateDiv.innerHTML="Ha mindenki belépett, és jó a sorrend, nyomd meg a Start gombot.";
                if (Object.keys(game.players).length>2) {
                    showEl("startButton", "inline-block");
                }
                showEl("newPlayerButton", "inline-block");
            } else if (me.state=="GAME_WAITING_FOR_MY_CHOICE"|| 
                       me.state=="CONFLICT_RESET") {
                if (myCard==-1) {
                    if (me.state=="CONFLICT_RESET") {
                        stateDiv.innerHTML="Valaki rosszul jelölt, kérlek (ismét) jelöld a saját lapodat!";
                    } else {
                        stateDiv.innerHTML="Jelöld meg a saját lapodat, amint lent vannak az asztalon a kártyák!";
                    }
                } else if (!me.teller) {
                    stateDiv.innerHTML="Jelöld meg a lapot" +
                    (me.state=="CONFLICT_RESET" ? " (ismét)":"") +
                    ", amelyikről szerinted a mesélő beszélt!";
                }
            } else if (me.state=="WAITING_FOR_OTHERS_CHOICE") {
                checkOtherPlayers();
                var ready=countReady();
                stateDiv.innerHTML="Megvárjuk, hogy a többiek is bejelöljék a kártyákat... (" +
                                   ready + "/" + Object.keys(game.players).length + ")";
            } else if (me.state=="ROUND_ENDED") {
                showEl("goOnButton");
                stateDiv.innerHTML="Kör vége, ha mindenki megnézte az eredményt, akkor valaki nyomja meg a tovább gombot!";
            }
        }

        function findNextPlayer() {
            var nextPlayer = null;
            Object.keys(game.players).forEach( function(pName) {
               if (game.players[pName].deviceHash==deviceHash &&
                   (game.players[pName].state=="GAME_WAITING_FOR_MY_CHOICE" ||
                    game.players[pName].state=="CONFLICT_RESET") &&
                   pName!=me.name) {
                   nextPlayer=game.players[pName];
               }
            });
            return nextPlayer;
        }

        function hideSigns() {
            hideCardSigns = true;
            updateCards();
        }

        function checkOtherPlayers(response) {
            var nextPlayer = findNextPlayer();
            if (nextPlayer!=null) {
                hideSigns();
                alert("Add át az mobilt/tabletet/laptopot a "+nextPlayer.name+"-nak/nek!\n"+
                      "Ha megtörtént, nyomd meg az OK-t");
                window.location.href=myAddress+"game.html?h="+nextPlayer.playerHash;
            }
        }

        function sendCards() {
            whileSettingCards = false;
            var choices = new Object();
            choices.ownCard = myCard;
            choices.guessCard = myChoice;
            choices.player = me.name;
            sendRest("setcards",doNothing, doNothing, true,choices);
            return;
        }

        function cardClicked(cardId) {
            if (me==null) return;
            if (me.state=="GAME_WAITING_FOR_MY_CHOICE" || 
                me.state=="CONFLICT_RESET") {
                if (myCard==-1) {
                    myCard = cardId;
                    if (me.teller) {
                        sendCards();
                    } else {
                        whileSettingCards = true;
                    }
                    updateCards();
                    updateStateAndButtons();
                } else if ((me.myCard!=cardId) && !me.teller) {
                    myChoice = cardId;
                    sendCards();
                }
            }
        }

        function updateCards() {
            var cardsDiv = getEl("cards");
            var pNum = Object.keys(game.players).length;
            var i;
            var cardsInner = "";
            for (i=0;i<pNum;i++) {
                cardsInner += "<div id=\"c" +i+ "\" " +
                    "style=\"display:inline-block;width:15%;height:200px;" +
                    "margin:10px;vertical-align:middle;background-color:#107da1;position:relative;" +
                    "border-radius: 20px; border: 10px solid #8A8E9B;line-height: 200px;\""+
                    "onClick=\"cardClicked("+i+")\" >" +
                   //"<h3 style=\"margin:0;font-size:60px;\" onClick=\"cardClicked("+i+")\">" + (i+1) + "</h3>" +
                    "<h3 style=\"margin:0;font-size:60px;\" >" + (i+1) + "</h3>";
                if (!hideCardSigns) {
	                if (i==myCard) {
	                    cardsInner += getRabbit(40,"black","10px", "5px", "white", "10px", "block");
	                }
	                if (i==myChoice) {
	                    cardsInner += getCircle("black","35px",TOP_RIGHT_POS);
	                    //cardsInner += "<img src=\"pict/circle.svg\" style=\"top:10px;right:10px;width:35px;height:35px;position:absolute;display:block;\">";
	                }
                }
                if (game.state=="ROUND_ENDED" || game.state=="GAME_ENDED") {
                    var chooseX = 10;
                    Object.keys(game.players).forEach(function(pName) {
                        var player = game.players[pName];
                        if (player.myCard==i) {
                            cardsInner += getRabbit(40,player.colorStr,"150px", "5px", "white", "10px", "block");
                        }
                        if (player.myChoice==i) {
                            cardsInner += getCircle(player.colorStr,"35px","bottom:12px;right:"+chooseX+"px");
                            chooseX+=10;
                        }
                    });
                }
                cardsInner += "</div>\n";
            }
            cardsDiv.innerHTML = cardsInner;
        }

        function doNothing(response) {
        }

        function playerUp(pId) {
            sendRest("playerUp/"+pId,doNothing);
        }

        function playerDown(pId) {
            sendRest("playerDown/"+pId,doNothing);
        }

        function updatePlayers() {
            var playerInner = "";
            pOrder.forEach(function(o,i) {
                var pName = Object.keys(game.players)[o];
                var player = game.players[pName];
                playerInner += "<div style=\"width:45%;background-color:"+ player.colorStr+
                                ";color:black;margin:10px;display:inline-block;"+
                                "text-align:left;" +
                                "line-height:50px;font-weight:bold;\">";
                playerInner += "<div style=\"width:55%;display:inline-block;margin:0;position:relative;"+
                               "padding-left:40px;\">"
                if (pName==me.name) {
                    playerInner += getRabbit(40,"black","5px", "0px", "white", "10px");
                } else if (player.deviceHash==me.deviceHash) {
                    playerInner += getRabbit(40,"gray","5px", "0px", "white", "10px");
                } else {
                    playerInner += "&nbsp; ";
                }
                playerInner += pName;
                if (player.teller) {
                    playerInner += " <img src=\"pict/book.svg\"" +
                                   " style=\"width:40px;height:40px;top:5px;position:relative;\"> ";
                }
                playerInner += "</div>";
                playerInner += "<div style=\"text-align:right;width:35%;display:inline-block;margin:0;font-size:30px;\">";
                if (player.state!="WAITING_FOR_GAME_START") {
                    if (player.state=="ROUND_ENDED") {
                        playerInner += (player.point-player.roundPoint) + "+" +
                                       player.roundPoint +"="+player.point+"&nbsp;";
                    } else {
                        playerInner += player.point+"&nbsp;";
                    }
                } else {
                    if (i!=0) {
                        playerInner += "<img src=\"pict/ArrowUp.svg\" onClick=\"playerUp("+player.playerId+");\"> &nbsp;";
                    }
                    if (i<pOrder.length-1) {
                        playerInner += "<img src=\"pict/ArrowDown.svg\" onClick=\"playerDown("+player.playerId+");\"> &nbsp;";
                    }
                }
                playerInner += "</div>";
                playerInner += "</div>";
            });
            getEl("players").innerHTML=playerInner;
        }

        function updateOrder() {
            pOrder = new Array();
            for(var i=0;i<Object.keys(game.players).length;i++) {
                pOrder.push(i);
            }
            pOrder.sort(function(a,b) {
                return (game.players[Object.keys(game.players)[a]].playerOrder - game.players[Object.keys(game.players)[b]].playerOrder);
            });
        }

        function updateGame(gameJson) {
            game = JSON.parse(gameJson);
            Object.keys(game.players).forEach(function(pName) {
                if (game.players[pName].playerHash==playerHash) {
                    if (me!=null) {
                        myLastState=me.state;
                    }
                    me = game.players[pName];
                    if (myLastState=="ROUND_ENDED" && me.state=="GAME_WAITING_FOR_MY_CHOICE") {
                        myCard=-1;
                        myChoice=-1;
                    }
                    getEl("dixitHeader").innerHTML="DIXITHELPER -- " +
                                                   getRabbit(80,me.colorStr,"10px", "10px", "white", "10px", "inline-block") +
                                                   pName + " -- kör: " + game.round;
                    if (!whileSettingCards) {
                        myCard = me.myCard;
                        myChoice = me.myChoice;
                    }
                }
            });
            updateOrder();
            updateStateAndButtons();
            updateCards();
            updatePlayers();
        }

        function checkVersion(version) {
            if (version!=lastVersion) {
                sendRest("getgame", updateGame);
                lastVersion = version;
            }
        }

        function pollState() {
            if (!running) {
                running = true;
                sendRest("getgameversion", checkVersion)
                running = false;
            }
            setTimeout(function() {pollState();}, 500);
        }

        function readPlayerFromURL() {
            var url = new URL(window.location.href);
            playerHash = url.searchParams.get("h");
        }

        function readDeviceHashAndPlayer() {
            readPlayerFromURL();
            deviceHash = getCookie("dixitDevice");
            if (deviceHash=="" || playerHash==null) {
                if (confirm("Nincs megadva eszköz azonosító, és/vagy játékos név.\n"+
                            " Javasolt visszatérni a kezdőoldalra. OK?")) {
                    window.location.href = myAddress + "start.html";
                } else {
                    alert("A játék így nem fog megfelelően működni.\n" +
                          "Olvasd be a kódot, vagy kattints a megjelenített linkre!");
                    getEl("state").innerHTML="<a href=\""+myAddress+"start.html\">"+
                                             myAddress+"start.html</a>";
                }
                return false;
            }
            return true;
        }

        function startSuceeded(response) {
            hideEl("startButton");
            hideEl("newPlayerButton");
        }

        function startGame() {
            if (confirm("Biztosan mindenki belépett a játékba?")) {
                sendRest("startgame",startSuceeded);
            }
        }

        function plusPlayer() {
            window.location.href = myAddress+"start.html";
        }

        function nextRound() {
            sendRest("nextRound",doNothing);
        }

        function init() {
            if (readDeviceHashAndPlayer()) {
                pollState();
            }
        }
    </script>
</head>

<body onLoad="init();" style="text-align:center; background-color:#101040; color:#D0D0E4; 
                              font-size:30px; width:100%; font-family:Arial;">
<h3 id="dixitHeader" style="text-align:center;">DIXITHELPER -- </h2>
<div id="state"></div>
<div id="cards"></div><br>
<div id="players"></div>

<br>
<div style="display:block;position:relative;text-align:center;width:100%;">
    <div id="startButton" style="display:inline-block;text-align:center;background-color:gray;
                border: 10px solid #D0D0E4;border-right-color:#A0A0B4;font-weight:bold;;
                border-bottom-color:#808094;width:200px;margin:auto;color:white;"
                onClick="startGame();">
        START
    </div>
    <div id="newPlayerButton" style="display:inline-block;text-align:center;background-color:gray;
                border: 10px solid #D0D0E4;border-right-color:#A0A0B4;font-weight:bold;;
                border-bottom-color:#808094;width:200px;margin:auto;color:white;"
                onClick="plusPlayer();">
        + JÁTÉKOS
    </div>
    <div id="goOnButton" style="display:none;text-align:center;background-color:gray;
                border: 10px solid #D0D0E4;border-right-color:#A0A0B4;font-weight:bold;;
                border-bottom-color:#808094;width:200px;margin:auto;color:white;"
                onClick="nextRound();">
        TOVÁBB
    </div>
</div>

</body>
</html>